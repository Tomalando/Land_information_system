<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>GeoServer WFS with Leaflet</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link 
    rel="stylesheet" 
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <style>
    #map { height: 100vh; margin: 0; }
  </style>
</head>
<body>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  const map = L.map('map').setView([0, 37], 7); // Set your preferred default view

  // Add OSM base layer
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: 'Â© OpenStreetMap contributors'
  }).addTo(map);

  // WFS URL from GeoServer
  const wfsUrl = 'http://localhost:8080/geoserver/LIS/ows?' +
    'service=WFS&version=1.0.0&request=GetFeature' +
    '&typeName=LIS:Lands_parcel&outputFormat=application/json';

  fetch(wfsUrl)
    .then(res => res.json())
    .then(data => {
      if (!data || !data.features || data.features.length === 0) {
        alert("No features returned from WFS.");
        return;
      }

      const geoLayer = L.geoJSON(data, {
        onEachFeature: function (feature, layer) {
          const props = feature.properties;
          const popupContent = `
            <b>Parcel ID:</b> ${props.parcel_id || 'N/A'}<br>
            <b>Owner:</b> ${props.owner || 'N/A'}<br>
            <b>Area:</b> ${props.area || 'N/A'} mÂ²
          `;
          layer.bindPopup(popupContent);
        },
        style: {
          color: 'blue',
          weight: 2,
          fillOpacity: 0.3
        }
      }).addTo(map);

      // Zoom to bounds of features
      map.fitBounds(geoLayer.getBounds());
    })
    .catch(err => {
      console.error("WFS fetch failed:", err);
      alert("Failed to load parcels from GeoServer. Check console for details.");
    });
</script>

</body>
</html>





<script>
    // Button click alerts (except search)
document.querySelectorAll('.btn').forEach((btn) => {
    if (btn.id !== 'searchBtn') {
        btn.addEventListener('click', () => {
            alert(${btn.textContent.trim()} functionality coming soon...);
        });
    }
});

// Base maps
const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors',
});
const esriSat = L.tileLayer(
    'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Tiles &copy; Esri' }
);

// Map initialization
const map = L.map('map', {
    center: [0.5167, 35.2833],
    zoom: 13,
    layers: [osm],
});
L.control.layers({ OpenStreetMap: osm, 'Esri Satellite': esriSat }).addTo(map);

// Draw control
const drawnItems = new L.FeatureGroup();
map.addLayer(drawnItems);
map.addControl(
    new L.Control.Draw({
        edit: { featureGroup: drawnItems },
        draw: {
            polygon: true,
            rectangle: true,
            marker: true,
            circle: false,
            polyline: false,
            circlemarker: false,
        },
    })
);

// References
let parcelsGeoJSON;
let parcelsBounds = null;
const totalParcelsEl = document.querySelector('.total-parcels h2');
const totalAreaEl = document.querySelector('.total-area h2');
const notificationsEl = document.querySelector('.notifications');

// Update parcel stats
function updateTotals() {
    if (!parcelsGeoJSON) return;
    const count = parcelsGeoJSON.getLayers().length + drawnItems.getLayers().length;
    let areaSum = 0;

    parcelsGeoJSON.eachLayer((layer) => {
        const area = layer.feature.properties.Area_Ha;
        if (area) areaSum += Number(area);
    });

    drawnItems.eachLayer((layer) => {
        if (layer instanceof L.Polygon) {
            const latlngs = layer.getLatLngs()[0];
            const areaMeters = L.GeometryUtil.geodesicArea(latlngs);
            areaSum += areaMeters / 10000;
        }
    });

    totalParcelsEl.textContent = count;
    totalAreaEl.textContent = areaSum.toFixed(2) + ' ha';
}

// Color mapping
const colorMap = {
    agriculture: '#b8860b',
    'public purpose': '#00008b',
    educational: '#87cefa',
    'public utility': '#808080',
    industrial: '#800080',
    recreational: '#228b22',
    undeveloped: '#ffffe0',
    residential: '#8b4513',
    commercial: '#ff0000',
};

// Load parcels from GeoServer
fetch('http://localhost:8080/geoserver/LIS/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=LIS:Kariobangi_parcels&outputFormat=application/json&srsName=EPSG:4326')
    .then((res) => res.json())
    .then((data) => {
        parcelsGeoJSON = L.geoJSON(data, {
            style: (feature) => {
                const lu = (feature.properties.Landuse || '').trim().toLowerCase();
                return {
                    color: colorMap[lu] || '#999',
                    weight: 2,
                    fillOpacity: 0.6,
                };
            },
            onEachFeature: (feature, layer) => {
                const props = feature.properties;
                layer.bindPopup(`
                    <strong>Parcel ID:</strong> ${props.PLOT_NUMBE || 'N/A'}<br>
                    <strong>Land Use:</strong> ${props.Landuse || 'Unknown'}<br>
                    <strong>Area:</strong> ${props.Area_Ha ? props.Area_Ha.toFixed(2) : '0.00'} ha<br>
                    <strong>Owner:</strong> ${props.Land_owner || 'Unknown'}
                `);
            },
        }).addTo(map);

        parcelsBounds = parcelsGeoJSON.getBounds();
        updateTotals();

        // Prepare chart data
        const areaMap = {},
            countMap = {};
        data.features.forEach((f) => {
            const lu = (f.properties.Landuse || 'unknown').trim().toLowerCase();
            const area = Number(f.properties.Area_Ha || 0);
            areaMap[lu] = (areaMap[lu] || 0) + area;
            countMap[lu] = (countMap[lu] || 0) + 1;
        });

        const areaLabels = Object.keys(areaMap);
        const areaValues = Object.values(areaMap);
        const areaColors = areaLabels.map((lu) => colorMap[lu] || '#999');

        const countLabels = Object.keys(countMap);
        const countValues = Object.values(countMap);
        const countColors = countLabels.map((lu) => colorMap[lu] || '#999');

        // Bar Chart
        new Chart(document.getElementById('landUseBarChart').getContext('2d'), {
            type: 'bar',
            data: {
                labels: areaLabels,
                datasets: [{
                    label: 'Area (Ha)',
                    data: areaValues,
                    backgroundColor: areaColors,
                    borderColor: '#333',
                    borderWidth: 1,
                }],
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: false },
                    title: { display: true, text: 'Land Use Area (Ha)' },
                },
                scales: {
                    y: { beginAtZero: true, title: { display: true, text: 'Area (Ha)' } },
                    x: { ticks: { color: '#333', font: { weight: 'bold' } } },
                },
            },
        });

        // Pie Chart
        new Chart(document.getElementById('landUseCountChart').getContext('2d'), {
            type: 'pie',
            data: {
                labels: countLabels,
                datasets: [{
                    label: 'Parcel Count',
                    data: countValues,
                    backgroundColor: countColors,
                    borderColor: '#fff',
                    borderWidth: 1,
                }],
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'right' },
                    title: { display: true, text: 'Parcels by Land Use (Count)' },
                },
            },
        });
    })
    .catch((err) => {
        console.error('Error loading parcel data:', err);
        notificationsEl.textContent = 'Error loading parcel data.';
    });

// Draw events
map.on('draw:created', (e) => {
    drawnItems.addLayer(e.layer);
    alert('Parcel drawn and added!');
    updateTotals();
});
map.on('draw:edited', updateTotals);
map.on('draw:deleted', updateTotals);

// Zoom to parcels
const ZoomToParcelControl = L.Control.extend({
    options: { position: 'topright' },
    onAdd: function() {
        const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom');
        container.innerHTML = 'ðŸ“';
        container.title = 'Zoom to Parcels';
        Object.assign(container.style, {
            backgroundColor: 'white',
            width: '34px',
            height: '34px',
            fontSize: '20px',
            textAlign: 'center',
            lineHeight: '34px',
            cursor: 'pointer',
            boxShadow: '0 1px 5px rgba(0,0,0,0.65)',
            marginTop: '48px',
        });
        container.onclick = function() {
            if (parcelsBounds && parcelsBounds.isValid()) {
                map.fitBounds(parcelsBounds);
            } else {
                alert('Parcels not loaded or bounds invalid.');
            }
        };
        return container;
    },
});
map.addControl(new ZoomToParcelControl());

// Parcel Search
document.getElementById('searchBtn').addEventListener('click', function() {
    const input = document.getElementById('searchInput').value.trim();
    let found = false;

    if (!input) {
        notificationsEl.textContent = 'âš  Please enter a Parcel Number.';
        return;
    }

    parcelsGeoJSON.eachLayer((layer) => {
        const props = layer.feature.properties;
        if (props.PLOT_NUMBE && props.PLOT_NUMBE.toString() === input) {
            found = true;
            layer.setStyle({
                color: 'yellow',
                weight: 4,
                dashArray: '5,5',
                fillOpacity: 0.7,
            });

            map.fitBounds(layer.getBounds());
            layer.openPopup();

            parcelsGeoJSON.eachLayer((l) => {
                if (l !== layer) parcelsGeoJSON.resetStyle(l);
            });

            notificationsEl.textContent = âœ… Parcel ${input} found and highlighted.;
        }
    });

    if (!found) {
        notificationsEl.textContent = âŒ Parcel "${input}" doesn't exist.;
    }
});

// Clear highlight when clicking outside a feature
map.on('click', function() {
    if (parcelsGeoJSON) {
        parcelsGeoJSON.eachLayer((layer) => {
            parcelsGeoJSON.resetStyle(layer);
        });
        notificationsEl.textContent = 'ðŸ§­ Highlight cleared. Click again to reselect.';
    }
});
</script>