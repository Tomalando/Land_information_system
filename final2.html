<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Parcel Viewer</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
  <style>
    body, html { margin: 0; padding: 0; height: 100%; }
    #map { height: 100vh; }
    .stats { position: absolute; top: 10px; left: 10px; background: white; padding: 10px; z-index: 1000; }
    .notifications { margin-top: 5px; color: darkred; font-weight: bold; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="stats">
    <div class="total-parcels">Parcels: <h2>0</h2></div>
    <div class="total-area">Total Area: <h2>0.00 ha</h2></div>
    <input type="text" id="searchInput" placeholder="Parcel Number" />
    <button class="btn" id="searchBtn">Search</button>
    <div class="notifications"></div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.geometryutil/0.9.3/leaflet.geometryutil.min.js"></script>
  <script>
    const map = L.map('map', {
      center: [1.7562, 40.0481],
      zoom: 17
    });

    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const esriSat = L.tileLayer(
      'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
      { attribution: 'Tiles &copy; Esri' }
    );

    L.control.layers({ 'OpenStreetMap': osm, 'Esri Satellite': esriSat }).addTo(map);

    const drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);
    map.addControl(new L.Control.Draw({
      edit: { featureGroup: drawnItems },
      draw: {
        polygon: true,
        rectangle: true,
        marker: true,
        circle: false,
        polyline: false,
        circlemarker: false,
      }
    }));

    let parcelsGeoJSON;
    let parcelsBounds = null;
    const totalParcelsEl = document.querySelector('.total-parcels h2');
    const totalAreaEl = document.querySelector('.total-area h2');
    const notificationsEl = document.querySelector('.notifications');

    function updateTotals() {
      if (!parcelsGeoJSON) return;
      const count = parcelsGeoJSON.getLayers().length + drawnItems.getLayers().length;
      let areaSum = 0;

      parcelsGeoJSON.eachLayer((layer) => {
        const area = layer.feature.properties.shape_area;
        if (area) areaSum += Number(area);
      });

      drawnItems.eachLayer((layer) => {
        if (layer instanceof L.Polygon) {
          const latlngs = layer.getLatLngs()[0];
          const areaMeters = L.GeometryUtil.geodesicArea(latlngs);
          areaSum += areaMeters;
        }
      });

      totalParcelsEl.textContent = count;
      totalAreaEl.textContent = (areaSum / 10000).toFixed(2) + ' ha';
    }

    fetch('http://localhost:8080/geoserver/LIS1/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=LIS1:land_parcels&maxFeatures=106&outputFormat=application/json')
      .then((res) => res.json())
      .then((data) => {
        parcelsGeoJSON = L.geoJSON(data, {
          style: {
            color: '#3388ff',
            weight: 2,
            fillOpacity: 0.5
          },
          onEachFeature: (feature, layer) => {
            const props = feature.properties;
            const areaHa = props.shape_area ? (props.shape_area / 10000).toFixed(2) : '0.00';
            const lengthM = props.shape_leng ? props.shape_leng.toFixed(2) : '0.00';
            layer.bindPopup(`
              <strong>Parcel No:</strong> ${props.parcel_no ?? 'N/A'}<br>
              <strong>FR No:</strong> ${props.fr_no ?? 'N/A'}<br>
              <strong>Owner:</strong> ${props.owner_name ?? 'Unknown'}<br>
              <strong>Area:</strong> ${areaHa} ha<br>
              <strong>Perimeter:</strong> ${lengthM} m
            `);
          }
        }).addTo(map);

        parcelsBounds = parcelsGeoJSON.getBounds();
        updateTotals();
      })
      .catch((err) => {
        console.error('Error loading parcel data:', err);
        notificationsEl.textContent = '‚ùå Failed to load parcel data.';
      });

    document.getElementById('searchBtn').addEventListener('click', function () {
      const input = document.getElementById('searchInput').value.trim();
      let found = false;

      if (!input) {
        notificationsEl.textContent = '‚ö† Please enter a Parcel Number.';
        return;
      }

      parcelsGeoJSON.eachLayer((layer) => {
        const props = layer.feature.properties;
        if (props.parcel_no && props.parcel_no.toString() === input) {
          found = true;
          layer.setStyle({
            color: 'yellow',
            weight: 4,
            dashArray: '5,5',
            fillOpacity: 0.7
          });

          map.fitBounds(layer.getBounds());
          layer.openPopup();

          parcelsGeoJSON.eachLayer((l) => {
            if (l !== layer) parcelsGeoJSON.resetStyle(l);
          });

          notificationsEl.textContent = `‚úÖ Parcel ${input} found and highlighted.`;
        }
      });

      if (!found) {
        notificationsEl.textContent = `‚ùå Parcel "${input}" not found.`;
      }
    });

    map.on('click', () => {
      if (parcelsGeoJSON) {
        parcelsGeoJSON.eachLayer((layer) => {
          parcelsGeoJSON.resetStyle(layer);
        });
        notificationsEl.textContent = 'üß≠ Highlight cleared. Click again to reselect.';
      }
    });

    map.on('draw:created', (e) => {
      drawnItems.addLayer(e.layer);
      alert('Parcel drawn and added!');
      updateTotals();
    });

    map.on('draw:edited', updateTotals);
    map.on('draw:deleted', updateTotals);

    document.querySelectorAll('.btn').forEach((btn) => {
      if (btn.id !== 'searchBtn') {
        btn.addEventListener('click', () => {
          notificationsEl.textContent = `‚ö†Ô∏è "${btn.textContent.trim()}" functionality is coming soon...`;
        });
      }
    });
  </script>
</body>
</html>
